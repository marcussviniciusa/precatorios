○ Compiling /api/webhook/evolution ...
 ✓ Compiled /api/webhook/evolution in 5.4s (1138 modules)
Webhook received: {
  "event": "messages.upsert",
  "instance": "teste",
  "data": {
    "key": {
      "remoteJid": "558496151588@s.whatsapp.net",
      "fromMe": false,
      "id": "AC6AF69D2590D2B105B069242E6EC9CD",
      "senderLid": "131082569682967@lid"
    },
    "pushName": "Marcus",
    "status": "DELIVERY_ACK",
    "message": {
      "imageMessage": {
        "url": "https://mmg.whatsapp.net/v/t62.7118-24/23727254_1289170726319708_2573781848465118205_n.enc?ccb=11-4&oh=01_Q5Aa2gEix63OuMO52hNH37GuZRSOx2w32fqn3ChZQgL0s5_2JQ&oe=68EBDA31&_nc_sid=5e03e0&mms3=true",
        "mimetype": "image/jpeg",
        "fileSha256": "lhYTCbi/Sl53r0NPR6xqqEsGmh8VA3Bmdm4z8C77Qus=",
        "fileLength": "144255",
        "height": 1507,
        "width": 1026,
        "mediaKey": "hhVNCyLunT4wF4E1i15OKT9qIhl8ryV6QV2QIPqcMl4=",
        "fileEncSha256": "kyF+v0gNDYD8MeeRYrlalKaC8QyLomGUpZ5ABvSTeWg=",
        "directPath": "/v/t62.7118-24/23727254_1289170726319708_2573781848465118205_n.enc?ccb=11-4&oh=01_Q5Aa2gEix63OuMO52hNH37GuZRSOx2w32fqn3ChZQgL0s5_2JQ&oe=68EBDA31&_nc_sid=5e03e0",
        "mediaKeyTimestamp": "1757701914",
        "jpegThumbnail": "/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABsbGxscGx4hIR4qLSgtKj04MzM4PV1CR0JHQl2NWGdYWGdYjX2Xe3N7l33gsJycsOD/2c7Z//////////////8BGxsbGxwbHiEhHiotKC0qPTgzMzg9XUJHQkdCXY1YZ1hYZ1iNfZd7c3uXfeCwnJyw4P/Zztn////////////////CABEIAEgAMQMBIgACEQEDEQH/xAAvAAACAwEBAAAAAAAAAAAAAAAABAIDBQEGAQEBAQEAAAAAAAAAAAAAAAABAgAD/9oADAMBAAIQAxAAAADQSsUxck/nzSPOS6TAmbMRahTKPeKuxQ0TAtOVM6mNWvoeZILyqbWKSshMzWqucw0xMty2Tqiwc3AONFQWckFnQMf/xAAoEAACAQMEAQQBBQAAAAAAAAABAgADERIEEyExURQVMlIQIkFTYYH/2gAIAQEAAT8AfkQck/jV8JGQ2vMQelMx/oylqEqj9JjVHWvisFjNf0sF7QXtwZZpls8pN9tzM9ynqn6CXlepuWzS0yp9YxaKMgcTZWUKBqPi3iVNG4+HMpU9Ql9tDKiVGvmpyiaarUNghi3pjbPYmQlNmpFCe4hR+RaAeIaYPcesqcKI+nNQZ+Z6Z/Er0jQbPK8TXOhuFnurfxie6H90EbVqxvYRdWiUvlc+J6mp5mufKET/AGWlpTsycibSR0VuTNpL9TZp/WbSfWGmviBAOpi0Kt9TNt/qYQQpa3E3UmazcSbiT//EAB8RAAIBAwUBAAAAAAAAAAAAAAABAhIhIgMQERMxIP/aAAgBAgEBPwBoXu+nFSiddzUVKRUyLxsZc+kskUMjZfHJG+//xAAdEQACAQQDAAAAAAAAAAAAAAAAASECEBIxESAy/9oACAEDAQE/AEO9fqCKdyxSzFD2cohGSH1av//Z",
        "contextInfo": {
          "pairedMediaType": "NOT_PAIRED_MEDIA"
        },
        "scansSidecar": "VnTtbJPTSKJB7Xpw2grXNoJbFss=",
        "scanLengths": [
          16039,
          128216
        ]
      },
      "messageContextInfo": {
        "deviceListMetadata": {
          "senderTimestamp": "1757599463",
          "recipientKeyHash": "KvnbOBGYYi1hkQ==",
          "recipientTimestamp": "1757636894"
        },
        "deviceListMetadataVersion": 2,
        "messageSecret": "73dusppx3KqWt3EoZVq8tj23P0TpcjaITlQJOSrRuMM="
      }
    },
    "contextInfo": {
      "pairedMediaType": "NOT_PAIRED_MEDIA"
    },
    "messageType": "imageMessage",
    "messageTimestamp": 1757701915,
    "instanceId": "7c694e1b-6ae4-4328-8888-d9c29d7204f8",
    "source": "android"
  },
  "destination": "https://ed76c0c6968b.ngrok-free.app/api/webhook/evolution",
  "date_time": "2025-09-12T15:31:55.399Z",
  "sender": "557191005656@s.whatsapp.net",
  "server_url": "https://api.marcussviniciusa.cloud",
  "apikey": "F97791CB-E165-4873-80CF-0FE79AACC076"
}
Processing individual message from: 558496151588@s.whatsapp.net
Message processed: image - "[Imagem enviada]" from 558496151588
Attempting to download media using Evolution API for message: AC6AF69D2590D2B105B069242E6EC9CD
Media decoded successfully from Evolution API (144255 bytes)
Buffer uploaded successfully to MinIO: images/2025-09-12T18-32-10-399Z-7tfjll.jpg { etag: '78e35f6733b3be8fa8ce46bb588ff23f', versionId: null }
Media saved to MinIO: https://s3.marcussviniciusa.cloud/precatorios-files/images/2025-09-12T18-32-10-399Z-7tfjll.jpg
Google Vision client initialized
Groq client initialized
Processing media type: image, mimeType: image/jpeg
Processing image with Google Vision OCR (image/jpeg)
OCR extracted 1147 characters
Extracted text from image: VANS
NS VA
ANS
SVAN
n
Sexta-feira, 12 de setembro
15:20
Vor Cores Hascimen
a
0
G
4
14
Changes from a...
Broadcasted new message to conversation:68c4553e89d1b3f2a8a04d8b
Scheduled AI processing for conversation 68c4553e89d1b3f2a8a04d8b in 3000ms (exec: 1757701933971.325)
 POST /api/webhook/evolution 200 in 18205ms
Client disconnected from WebSocket: pJlqZRrC1RdyXeJUAAAJ
 GET /conversations 200 in 209ms
Client connected to WebSocket: NgTFC8C6GSN_M1b7AAAM
 GET /api/conversations 200 in 370ms
 GET /api/conversations 200 in 371ms
Processing grouped messages for conversation 68c4553e89d1b3f2a8a04d8b after 3000ms delay (exec: 1757701933971.325)
Actually processing with IA for conversation 68c4553e89d1b3f2a8a04d8b (exec: 1757701933971.325)
User messages found: 5
Messages content: ["Bom dia", "Tudo bem", "Me chamo marcus", "Oi", "VANS
NS VA
ANS
SVAN
n
Sexta-feira, 12 de setembro
15:20
Vor Cores Hascimen
a
0
G
4
14
Changes from all commits File filter Conversations.
Q Filter changed files
agents
rule excessive mat amount/vo
agents/rule excessive at amount/ve_11/excess
00-12,6 +12,7 0
12
Dexcessive mat amount.py
12
回
find right unit,
13 13
load price tables,
rule excessive therapies/v0.0.2
14 14
'
15
Drule excessive therapies ...
from agents.to be utils.characters
15
16
from agents.to be,utils. load base i
rule fee payment/v2.0.1
16
17
from agents.to be utils.net filter
17
18
Drule Improper fee paymen...
7
from agents.to be utils.prepare data
00-445,7 +446,600 def rule assesse
fleat
445
446
447
448
1
?
6
1
2
3 €
4
5
6
7
8
9
O
Q
W
E
R
T
Y
U
0
P
9
D
A
S
D
F
G
H
୮
K
L
C
;
Z
X
C
V
B
N
M
fn
τ
H
H
command
option
control
option
command
.
+
=
419
4
458
411
457
Filtering items with specialis
glosas, filtered, df evaluated i
df evaluated-df evaluated, agent,id-self.
glosas, filtered
glesas, filtered.joint
with free unit/lidarve"
"proced cirina", "procedia terap
-417,15 457, def rule assessment(self
times flast
lat.collevents"), pl.co
at Pedir in atted dia
Portugus6
O"]
Grouped message: "Bom dia Tudo bem Me chamo marcus Oi VANS
NS VA
ANS
SVAN
n
Sexta-feira, 12 de setembro
15:20
Vor Cores Hascimen
a
0
G
4
14
Changes from all commits File filter Conversations.
Q Filter changed files
agents
rule excessive mat amount/vo
agents/rule excessive at amount/ve_11/excess
00-12,6 +12,7 0
12
Dexcessive mat amount.py
12
回
find right unit,
13 13
load price tables,
rule excessive therapies/v0.0.2
14 14
'
15
Drule excessive therapies ...
from agents.to be utils.characters
15
16
from agents.to be,utils. load base i
rule fee payment/v2.0.1
16
17
from agents.to be utils.net filter
17
18
Drule Improper fee paymen...
7
from agents.to be utils.prepare data
00-445,7 +446,600 def rule assesse
fleat
445
446
447
448
1
?
6
1
2
3 €
4
5
6
7
8
9
O
Q
W
E
R
T
Y
U
0
P
9
D
A
S
D
F
G
H
୮
K
L
C
;
Z
X
C
V
B
N
M
fn
τ
H
H
command
option
control
option
command
.
+
=
419
4
458
411
457
Filtering items with specialis
glosas, filtered, df evaluated i
df evaluated-df evaluated, agent,id-self.
glosas, filtered
glesas, filtered.joint
with free unit/lidarve"
"proced cirina", "procedia terap
-417,15 457, def rule assessment(self
times flast
lat.collevents"), pl.co
at Pedir in atted dia
Portugus6
O"
 GET /api/conversations 200 in 363ms
Client NgTFC8C6GSN_M1b7AAAM joined conversation:68c4553e89d1b3f2a8a04d8b
 ✓ Compiled /api/conversations/[conversationId]/messages in 461ms (1140 modules)
OpenRouter response: {
  "id": "gen-1757701938-CkKdW74vf56NMTRORd8N",
  "provider": "OpenAI",
  "model": "openai/gpt-4.1-mini",
  "object": "chat.completion",
  "created": 1757701938,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "{\n  \"Nome\": \"marcus\"\n}",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_4fce0778af",
  "usage": {
    "prompt_tokens": 1129,
    "completion_tokens": 10,
    "total_tokens": 1139,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}
AI extracted lead info: { Nome: 'marcus' }
 GET /api/conversations/68c4553e89d1b3f2a8a04d8b/messages 200 in 1856ms
 ✓ Compiled /api/conversations/[conversationId]/instance in 402ms (1143 modules)
OpenRouter response: {
  "id": "gen-1757701939-PRQ5GNPwm9NkGwfXnlAH",
  "provider": "OpenAI",
  "model": "openai/gpt-4.1-mini",
  "object": "chat.completion",
  "created": 1757701939,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "{\n  \"score\": 0,\n  \"classification\": \"discard\",\n  \"reasoning\": \"Lead não possui precatório confirmado, valor elegível, estado elegível, não demonstra urgência clara, não enviou documentos e não apresentou interesse claro.\"\n}",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_4fce0778af",
  "usage": {
    "prompt_tokens": 874,
    "completion_tokens": 53,
    "total_tokens": 927,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}
OpenRouter response: {
  "id": "gen-1757701940-4uiRhieUSdolcnbRJJE1",
  "provider": "OpenAI",
  "model": "openai/gpt-4.1-mini",
  "object": "chat.completion",
  "created": 1757701940,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Marcus, não entendi as informações enviadas. Você pode confirmar se tem precatório e informar o estado e o valor aproximado?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_4fce0778af",
  "usage": {
    "prompt_tokens": 1394,
    "completion_tokens": 27,
    "total_tokens": 1421,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}
 GET /api/conversations/68c4553e89d1b3f2a8a04d8b/instance 200 in 1892ms
 ✓ Compiled /api/conversations/[conversationId]/read in 375ms (1145 modules)
Broadcasted new message to conversation:68c4553e89d1b3f2a8a04d8b
AI response sent to 558496151588: "Marcus, não entendi as informações enviadas. Você pode confirmar se tem precatório e informar o estado e o valor aproximado?"
Finished processing conversation 68c4553e89d1b3f2a8a04d8b (exec: 1757701933971.325)
Webhook received: {
  "event": "send.message",
  "instance": "teste",
  "data": {
    "key": {
      "remoteJid": "558496151588@s.whatsapp.net",
      "fromMe": true,
      "id": "3EB092C61CA0131EAAA0843FB9BBD91AFB758879"
    },
    "pushName": "Você",
    "status": "PENDING",
    "message": {
      "conversation": "Marcus, não entendi as informações enviadas. Você pode confirmar se tem precatório e informar o estado e o valor aproximado?"
    },
    "contextInfo": null,
    "messageType": "conversation",
    "messageTimestamp": 1757701941,
    "instanceId": "7c694e1b-6ae4-4328-8888-d9c29d7204f8",
    "source": "unknown"
  },
  "destination": "https://ed76c0c6968b.ngrok-free.app/api/webhook/evolution",
  "date_time": "2025-09-12T15:32:22.393Z",
  "sender": "557191005656@s.whatsapp.net",
  "server_url": "https://api.marcussviniciusa.cloud",
  "apikey": "F97791CB-E165-4873-80CF-0FE79AACC076"
}
 POST /api/webhook/evolution 200 in 480ms
Webhook received: {
  "event": "messages.update",
  "instance": "teste",
  "data": {
    "keyId": "3EB092C61CA0131EAAA0843FB9BBD91AFB758879",
    "remoteJid": "558496151588@s.whatsapp.net",
    "fromMe": true,
    "participant": "558496151588@s.whatsapp.net",
    "status": "DELIVERY_ACK",
    "instanceId": "7c694e1b-6ae4-4328-8888-d9c29d7204f8",
    "messageId": "cmfh6cqr63uk4o55bqo8q20iu"
  },
  "destination": "https://ed76c0c6968b.ngrok-free.app/api/webhook/evolution",
  "date_time": "2025-09-12T15:32:22.947Z",
  "sender": "557191005656@s.whatsapp.net",
  "server_url": "https://api.marcussviniciusa.cloud",
  "apikey": "F97791CB-E165-4873-80CF-0FE79AACC076"
}
 POST /api/webhook/evolution 200 in 21ms
 POST /api/conversations/68c4553e89d1b3f2a8a04d8b/read 200 in 1728ms


